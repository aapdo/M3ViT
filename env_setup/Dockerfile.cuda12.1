# NGC PyTorch Docker image with custom requirements
# Build with: 
# docker build -t mtl:cuda12.1 -f env_setup/Dockerfile.cuda12.1 .
# Start with: 
# docker run --gpus all --shm-size="120g" -d --name m3vit \
#     -v /home/jy/m3vit:/home/jy/m3vit \
#     -v /data/multi_task_datasets:/data/multi_task_datasets \
#     m3vit:cuda12.1 sleep infinity

FROM nvcr.io/nvidia/pytorch:24.01-py3

RUN apt-get update

# Copy requirements
COPY env_setup/requirements.txt /tmp/requirements.txt

# Copy entrypoint script
COPY env_setup/docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod 777 /usr/local/bin/docker-entrypoint.sh

# Create user and group 'jy' with fixed UID/GID 1001
RUN groupadd -g 1001 jy \
    && useradd -m -s /bin/bash -u 1001 -g 1001 jy \
    && echo "jy ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

WORKDIR /home/jy

# Install FastMoE
RUN git clone https://github.com/laekov/fastmoe.git /tmp/fastmoe \
    && cd /tmp/fastmoe \
    && python setup.py install \
    && cd / \
    && rm -rf /tmp/fastmoe

# ---------------------------------------------------
# 1) Remove ALL system-level OpenCV to avoid conflicts
# ---------------------------------------------------
RUN apt-get remove -y python3-opencv || true \
    && apt-get purge -y python3-opencv || true \
    && rm -rf /usr/local/lib/python3.10/dist-packages/cv2* \
    && rm -rf /usr/lib/python3/dist-packages/cv2* \
    && rm -rf /usr/local/lib/python3.10/site-packages/cv2* \
    && rm -rf /usr/lib/python3.10/site-packages/cv2*


# Install system packages needed for cv2 + GUI deps
RUN apt-get install -y \
    vim \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxrender1 \
    libxext6 \
    && rm -rf /var/lib/apt/lists/*

# --------------------------------------------------------
# 2) Install Python dependencies (requirements.txt includes
#    opencv-python==4.6.0.66 â€” pip version ONLY)
# --------------------------------------------------------
# This guarantees cv2 will come ONLY from pip.
RUN pip install --no-cache-dir -r /tmp/requirements.txt \
    && rm /tmp/requirements.txt

USER jy

ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
CMD ["/bin/bash"]